#include<math.h>
#include <stdio.h>
#include <stdlib.h>
#include "extra_logk.h"
#include "extra_pk.h"

double func(double x, double a0, double b1, double b2, double b3); 
double func2(double x, double a0, double a1, double a2);

int pade(int nk, double *k, double *Pk, int npts, double *k_out, double *Pk_out)
{

  int i; 
  double x0, y0, x1, y1, x2, y2, x3, y3; 

/*   x0 = k[nk-100]; y0 = Pk[nk-100]; */
/*   x1 = k[nk-50]; y1 = Pk[nk-50]; */
/*   x2 = k[nk-1]; y2 = Pk[nk-1]; */

  double offset = 100; 

  /* for (i = 0; i < nk; i++) */
  /*   Pk[i] -= offset; */

  /* for (i = 0; i < nk; i++) */
  /*   Pk[i] *= exp(-k[i]*k[i]);  */

  x0 = k[nk-50]; y0 = Pk[nk-50];
  x1 = k[nk-25]; y1 = Pk[nk-25];
  x2 = k[nk-1];  y2 = Pk[nk-1];
  //   x3 = k[nk-1]; y3 = Pk[nk-1];


  double a0 = 0;
  double b1 = 0;
  double b2 = 0;
  double b3 = 0; 

  double a1 = 0; 
  double a2 = 0; 

  /// Approximation of the form: y = a0*x*x+a1*x+a2
  a1  = y1 - y2 + (y1-y0)*(x1*x1-x2*x2)/(x0*x0-x1*x1);
  a1 /= ((x1-x0)*(x1*x1-x2*x2)/(x0*x0-x1*x1)+x1-x2);
  
/*   a0  = y0-y1+a1*(x1-x0); */
/*   a0 /= (x0*x0-x1*x1); */

  a2 = y0 - a0*x0*x0 - a1*x0;

  ///// Approximation of the form: y = a0/(1+b1*x+b2*x*x)//////

/*   b2 = (y1 - y0) + (y1 - y2)*(y0*x0-y1*x1)/(y1*x1-y2*x2); */
/*   b2 /= ((y0*x0*x0-y1*x1*x1)+(y2*x2*x2-y1*x1*x1)*(y0*x0-y1*x1)/(y1*x1-y2*x2)); */

/*   b1 = (y2-y1)+b2*(y2*x2*x2-y1*x1*x1); */
/*   b1 /= (y1*x1-y2*x2); */

/*   a0 = y0*(1.+b1*x0+b2*x0*x0); */

  ////// Approximation of the form:  y = a0/(1+b2*x*x)  ///////
/*   b2 = (y0 - y1)/(x1*x1*y1-x0*x0*y0); */
/*   a0 = y0*(1.+b2*x1*x1); */


  //// Approximation of the form: y = a0/(1+b1*x+b2*x*x+b3*x*x*x);
/*   double reslt = x1*x1*y1-x3*x3*y3+(x2*x2*y2-x3*x3*y3)*(x3*y3-x1*y1)/(x2*y2-x3*y3); */

/*   b3 = reslt*(y0-y1)+y3-y1+(x3*y3-x1*y1)*(y3-y2)/(x2*y2-x3*y3); */
/*   b3 /= (reslt*(x1*x1*x1*y1-x0*x0*x0*y0+(x1*y1-x0*y0)/(x2*y2-x3*y3)*(x3*x3*x3*y3-x2*x2*x2*y2))+(x3*y3-x1*y1)/(x2*y2-x3*y3)*(x2*x2*x2*y2-x3*x3*x3*y3)+x1*x1*x1*y1-x3*x3*x3*y3); */

/*   b2 = y3-y1+(x3*y3-x1*y1)/(x2*y2-x3-y3)*(y3-y2+b3*(x3*x3*x3*y3-x2*x2*x2*y2))+b3*(x3*x3*x3*y3-x1*x1*x1*y1); */
/*   b2 /= reslt; */

/*   b1 = y3-y2 + b2*(x3*x3*y3-x2*x2*y2)+b3*(x3*x3*x3*y3-x2*x2*x2*y2); */
/*   b1 /= x2*y2-x3*y3; */

/*   a0 = y0+b1*x0*y0+b2*x0*x0*y0+b3*x0*x0*x0*y0; */

/*   fprintf(stderr, "%f %f %f\n", a0, a1, a2);  */

  //Straight up linear bias on large scales
  for (i = 0; i < 379; i++)
    {
      Pk_out[i] = Pk[0]; 
      //      Pk_out[i] = 1.;
    }
  // Leave emulated regime untouched
  for(i=0; i< 330; i++)
    {
      Pk_out[i+379]=Pk[i]; 
      //      Pk_out[i] = 1.;
    }
  // Now do Pade approximation
  for(i = 709; i < npts; i++)
    {
      double k = pow(10.,k_out[i]); 
      //      double bias_ext = func(k, a0, b1, b2, b3); 
      double bias_ext= func2(k, a0, a1, a2); 
      Pk_out[i] = bias_ext*exp(-k/50); 
      //      Pk_out[i] = 1.;
    }


  /* ------------------------------------------------
  float kmin = -8; 
  float kmax = log10(k[0]); 
  int nk_out = 0; 
  float binwidth = (kmax-kmin)/(float)(npts-1); 

  float n = 0.963;
  float A = Pk[0]/pow(k[0],n);



  // extend to larger scales using power law
  for (i = 0; i < 51; i++)
    {
      float new_k = pow(10.,kmin+binwidth*i);
      if (i != (npts-1))
  	{
  	  k_out[nk_out] = new_k;
 	  Pk_out[nk_out] = A*pow(new_k, n); //Pk[0];//
	  //Pk_out[nk_out] = log10(Pk_out[nk_out]); 
  	  nk_out++;
  	}
    }


  //original power spectrum
  for (i = 0; i < nk; i++)
    {
      k_out[nk_out] = k[i]; 
      Pk_out[nk_out] = Pk[i]; 
      nk_out++;
    }


  kmin = log10(k[nk-1]); 
  kmax = 11.;
  //  npts = 51; 
  binwidth = (kmax-kmin)/(float)(npts-1); 
  

  // extend to smaller scales using Pade approximation
  for (i = 0; i < 51; i++)
    {
      //      double new_k = pow(10.,kmin+binwidth*i); 
      double new_k = k_out[nk_out]; 
      double pade = func(new_k, a0, b1, b2, b3); 
      //      double pade = func2(new_k, a0, a1, a2); 
      if (i !=0)
	{
	  k_out[nk_out] = new_k; 
	  Pk_out[nk_out] = pade; 
	  nk_out++;
	}
    }

--------------------------------------------------  */
  return(0);
}

double func(double x, double a0, double b1, double b2, double b3)
{

  double f = a0/(1+b1*x+b2*x*x); 

  return(f); 
}

double func2(double x, double a0, double a1, double a2)
{

  double f = a0*x*x+a1*x+a2;

  return(f); 
}

